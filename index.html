<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Starfall Galaxy</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://unpkg.com/@tonconnect/ui@latest/dist/tonconnect-ui.min.js"></script>
    <style>
        /* All CSS is identical, with wallet and related styles being replaced/added */
        * { box-sizing: border-box; margin: 0; padding: 0; }
        html, body { width: 100%; height: 100%; overflow: hidden; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        body { background: #000; display: flex; justify-content: center; align-items: center; color: white; }
        #game-world { position: relative; width: 100%; height: 100%; max-width: 600px; max-height: 900px; overflow: hidden; background-color: #0b0f2b; cursor: none; }
        #galaxy-canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 0; }
        .screen-shake { animation: screen-shake-anim 0.4s ease-in-out; }
        @keyframes screen-shake-anim { 0%, 100% { transform: translateX(0); } 20%, 60% { transform: translateX(-10px); } 40%, 80% { transform: translateX(10px); } }
        #spinner-container { position: relative; width: 120px; height: 120px; display: flex; justify-content: center; align-items: center; margin: 10px 0; }
        #spinner { width: 100%; height: 100%; border: 8px solid rgba(255, 180, 0, 0.3); border-top-color: #ffb400; border-radius: 50%; }
        #spinner.spinning { animation: spin-anim 0.5s linear infinite; }
        @keyframes spin-anim { to { transform: rotate(360deg); } }
        #spinner-result { position: absolute; font-size: 2rem; font-weight: bold; color: white; }
        .hidden { display: none !important; }
        .game-ui { position: absolute; top: 15px; font-size: clamp(1.2rem, 4vw, 1.8rem); font-weight: bold; text-shadow: 2px 2px 4px rgba(0,0,0,0.5); z-index: 10; opacity: 0; transition: opacity 0.3s; } #score-display { left: 20px; transition: color 0.2s, text-shadow 0.2s; } #score-display.boosted { color: gold; text-shadow: 0 0 10px gold; } #lives-display { right: 20px; } .game-ui.visible { opacity: 1; } #level-up-banner { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%) scale(0); font-size: clamp(2rem, 10vw, 4rem); font-weight: bold; color: #ffb400; text-shadow: 0 0 20px #fff; opacity: 0; transition: transform 0.3s ease-out, opacity 0.3s ease-out; z-index: 50; } #level-up-banner.show { transform: translate(-50%, -50%) scale(1); opacity: 1; } #catcher { position: absolute; bottom: 5%; width: 20%; max-width: 120px; height: auto; transform: translateX(-50%); z-index: 5; filter: drop-shadow(0 0 10px #ffb400); transition: filter 0.1s linear; opacity: 0; pointer-events: none; } #catcher.visible { opacity: 1; pointer-events: auto; } #shield-effect { position: absolute; width: 130%; height: 130%; top: 50%; left: 50%; transform: translate(-50%, -50%); border: 3px solid #7DF9FF; border-radius: 50%; box-shadow: 0 0 20px #7DF9FF; display: none; } #catcher.shielded #shield-effect { display: block; animation: pulse 1.5s infinite; } .game-object { position: absolute; font-size: clamp(1.5rem, 6vw, 2.5rem); user-select: none; pointer-events: none; text-shadow: 0 0 10px currentColor; z-index: 1; } .star { color: #f7e733; } .golden-star { color: #ffd700; } .bomb { color: #ff4136; transform: scale(1.2); } .heart { color: #ff69b4; } .booster { color: #7DF9FF; animation: pulse 1s infinite; font-size: clamp(2rem, 7vw, 3rem); } #booster-display { position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.5); border-radius: 10px; padding: 10px; display: flex; align-items: center; gap: 10px; z-index: 20; border: 2px solid #ffb400; opacity: 0; transition: opacity 0.3s; pointer-events: none; } #booster-display.visible { opacity: 1; } #booster-icon { font-size: 1.5rem; } #booster-timer-bar-container { width: 150px; height: 15px; background: #333; border-radius: 5px; overflow: hidden; } #booster-timer-bar { height: 100%; background: #ffb400; width: 100%; transition: width 0.1s linear; }
        
        /* --- MODIFIED: Wallet Screen Styles --- */
        .wallet-card {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 20px;
            width: 100%;
            max-width: 380px;
            margin-bottom: 15px;
            border: 1px solid rgba(255, 180, 0, 0.2);
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        #wallet-screen .overlay-content {
            padding: 20px;
            justify-content: flex-start;
            padding-top: 80px;
            overflow-y: auto;
        }
        #wallet-balances {
            display: flex;
            flex-direction: column;
            gap: 15px;
            background: none;
            padding: 0;
            text-align: left;
            width: 100%;
        }
        .balance-row {
            display: grid;
            grid-template-columns: 1fr auto;
            align-items: center;
            font-size: clamp(1.2rem, 4vw, 1.5rem);
            padding-bottom: 10px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        .balance-row:last-child {
            border-bottom: none;
            padding-bottom: 0;
        }
        .balance-label {
            font-size: clamp(1rem, 3.5vw, 1.2rem);
            opacity: 0.9;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .balance-amount { font-weight: bold; }
        .conversion-info {
            text-align: center;
            font-size: 0.9rem;
            color: #ccc;
            line-height: 1.6;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            padding-top: 15px;
        }
        .conversion-info p { margin: 0; }
        #withdraw-card h3 {
            text-align: center;
            margin-bottom: 5px;
            font-size: 1.3rem;
            font-weight: 500;
            color: #ffb400;
        }
        #withdraw-section {
            display: flex;
            flex-direction: column;
            gap: 15px;
            width: 100%;
            margin-top: 0;
        }
        #withdraw-amount {
            width: 100%;
            padding: 15px;
            font-size: 1.2rem;
            border-radius: 8px;
            border: 2px solid #ffb400;
            background: rgba(0,0,0,0.5);
            color: white;
            text-align: center;
            transition: box-shadow 0.2s, border-color 0.2s;
        }
        #withdraw-amount:focus {
            outline: none;
            box-shadow: 0 0 10px #ffb400;
            border-color: #ffd66b;
        }
        #withdraw-amount::placeholder { color: #888; }
        #withdraw-button { width: 100%; padding: 15px; font-size: 1.2rem; }
        #conversion-timer { font-weight: bold; color: #ffb400; }
        #wallet-user-info { display: flex; align-items: center; gap: 8px; font-size: 1.1rem; color: #ccc; margin-bottom: 15px; background: rgba(0,0,0,0.2); padding: 8px 12px; border-radius: 8px; } #telegram-username { font-weight: bold; color: #fff; }
        
        #main-menu-balances { display: flex; justify-content: center; align-items: center; gap: 15px; margin-bottom: 30px; flex-wrap: wrap; } 
        .balance-display { display: flex; align-items: center; background: rgba(0,0,0,0.4); padding: 10px 15px; border-radius: 10px; font-size: clamp(1.2rem, 4vw, 1.6rem); font-weight: bold; border: 1px solid #ffb400; } .balance-display span:first-child { margin-right: 8px; font-size: 1.2em; } .modal-overlay { position: absolute; inset: 0; background-color: rgba(0, 0, 0, 0.85); display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center; z-index: 200; opacity: 0; transition: opacity 0.3s ease-in-out; pointer-events: none; } .modal-overlay.visible { opacity: 1; pointer-events: auto; } .modal-overlay .overlay-content { max-width: 90%; max-height: 90%; } #wallet-info-modal p { text-align: left; max-width: 400px; width: 90%; } #wallet-info-modal p:not(:last-of-type) { margin-bottom: 15px; } .info-button { position: absolute; top: 25px; right: 25px; width: 30px; height: 30px; border-radius: 50%; border: 2px solid #ffb400; background: rgba(0,0,0,0.5); color: #ffb400; font-size: 1.2rem; font-weight: bold; cursor: pointer; display: flex; justify-content: center; align-items: center; transition: background 0.2s, color 0.2s; z-index: 110; } .info-button:hover { background: #ffb400; color: #0b0f2b; } .shop-item-booster { font-size: 0.8rem; color: #7DF9FF; margin-top: 5px; } .particle { position: absolute; border-radius: 50%; pointer-events: none; z-index: 20; animation: fade-out 0.7s forwards; } @keyframes fade-out { to { transform: translateY(20px) scale(0); opacity: 0; } } @keyframes pulse { 50% { transform: scale(1.2); } } .overlay { position: absolute; inset: 0; background-color: rgba(0, 0, 0, 0.7); display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center; z-index: 100; opacity: 0; transition: opacity 0.5s ease-in-out; pointer-events: none; backdrop-filter: blur(5px); } .overlay.visible { opacity: 1; pointer-events: auto; } .overlay-content { display: flex; flex-direction: column; align-items: center; gap: 20px; padding: 20px; width: 100%; height: 100%; position: relative; } .overlay h1 { font-size: clamp(3rem, 12vw, 5rem); text-shadow: 0 0 15px #ffb400, 0 0 5px #fff; margin-bottom: 0; } .overlay h2 { font-size: clamp(2rem, 10vw, 4rem); position: relative; width: 100%; text-align: center; margin-bottom: 10px; } .overlay p { font-size: clamp(1rem, 4vw, 1.5rem); max-width: 80%; line-height: 1.5; } .menu-buttons { display: flex; flex-direction: column; gap: 15px; width: 250px; max-width: 80%; } .menu-button { padding: 15px; font-size: clamp(1.2rem, 4vw, 1.6rem); cursor: pointer; border: 2px solid #ffb400; border-radius: 10px; background: rgba(0,0,0,0.5); color: #ffb400; font-weight: bold; transition: background 0.2s, color 0.2s, transform 0.2s; } .menu-button:hover:not(:disabled) { background: #ffb400; color: #0b0f2b; transform: scale(1.05); } .menu-button:disabled { opacity: 0.5; cursor: not-allowed; } .play-button { background: #ffb400; color: #0b0f2b; } .play-button:hover { background: #ffd66b; } 
        .header-back-button {
            position: absolute;
            top: 50%;
            left: 20px;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: white;
            font-size: 2.5rem;
            font-weight: bold;
            cursor: pointer;
            padding: 0 10px;
            line-height: 1;
            opacity: 0.8;
            transition: opacity 0.2s, transform 0.2s;
        }
        .header-back-button:hover { opacity: 1; transform: translateY(-50%) scale(1.1); }
        #shop-header { display: flex; justify-content: center; align-items: center; gap: 10px; background: rgba(0,0,0,0.3); padding: 10px; border-radius: 10px; width: 100%; max-width: 500px; } #shop-header span:not(:first-child) { font-size: 1.5rem; font-weight: bold; } #shop-items-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 15px; width: 100%; max-width: 500px; padding: 20px; flex: 1; overflow-y: auto; overscroll-behavior-y: contain; } #shop-items-container::-webkit-scrollbar { width: 8px; } #shop-items-container::-webkit-scrollbar-track { background: rgba(0,0,0,0.2); border-radius: 4px; } #shop-items-container::-webkit-scrollbar-thumb { background: #ffb400; border-radius: 4px; } #shop-items-container::-webkit-scrollbar-thumb:hover { background: #ffd66b; } .shop-item { background: rgba(255,255,255,0.1); border-radius: 10px; padding: 10px; display: flex; flex-direction: column; align-items: center; gap: 10px; border: 2px solid transparent; transition: border-color 0.2s; } .shop-item.equipped { border-color: #ffb400; } .shop-item-preview svg { width: 80px; height: auto; } .shop-item-name { font-weight: bold; } .shop-item-button { width: 100%; padding: 8px; border-radius: 5px; border: none; font-weight: bold; cursor: pointer; } .shop-item-button.buy { background: #28a745; color: white; } .shop-item-button.equip { background: #007bff; color: white; } .shop-item-button.equipped { background: #6c757d; color: white; } .shop-item-button:disabled { background: #333; color: #777; cursor: not-allowed; } .setting { display: flex; justify-content: space-between; align-items: center; width: 100%; } .switch { position: relative; display: inline-block; width: 60px; height: 34px; } .switch input { opacity: 0; width: 0; height: 0; } .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 34px; } .slider:before { position: absolute; content: ""; height: 26px; width: 26px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; } input:checked + .slider { background-color: #ffb400; } input:checked + .slider:before { transform: translateX(26px); }
        #wallet-connector { display: flex; align-items: center; justify-content: center; gap: 10px; width: 100%; max-width: 380px; padding: 12px; margin: 0 0 15px 0; border-radius: 12px; border: 2px solid; cursor: pointer; font-weight: bold; font-size: 1.1rem; transition: all 0.2s ease-in-out; }
        #wallet-connector.disconnected { border-color: #ffb400; background: rgba(255, 180, 0, 0.1); color: #ffb400; }
        #wallet-connector.disconnected:hover { background: rgba(255, 180, 0, 0.25); transform: scale(1.02); }
        #wallet-connector.connected { border-color: #28a745; background: rgba(40, 167, 69, 0.15); color: #28a745; }
        #wallet-connector.connected:hover { background: rgba(220, 53, 69, 0.25); border-color: #dc3545; color: #dc3545; }
        #wallet-connector-text { font-family: monospace; }
    </style>
</head>
<body>
    <div id="game-world">
        <canvas id="galaxy-canvas"></canvas>
        <div id="score-display" class="game-ui">Score: 0</div>
        <div id="lives-display" class="game-ui"></div>
        <div id="level-up-banner">Level Up!</div>
        <svg id="catcher" viewBox="0 0 100 60"><g id="catcher-content"></g><foreignObject x="0" y="0" width="100%" height="100%"><div id="shield-effect"></div></foreignObject></svg>
        <div id="booster-display"><span id="booster-icon"></span><div id="booster-timer-bar-container"><div id="booster-timer-bar"></div></div></div>
        
        <!-- Menus -->
        <div id="main-menu" class="overlay">
            <div class="overlay-content">
                <h1>Starfall Galaxy</h1>
                <div id="main-menu-balances">
                    <div class="balance-display"><span>✨</span><span id="main-menu-crystal-balance">0</span></div>
                    <div class="balance-display"><span>⭐️</span><span id="main-menu-star-balance">0.0000</span></div>
                    <div class="balance-display">
                        <span>❤️</span>
                        <span id="main-menu-life-balance">5</span>
                        <span id="main-menu-life-timer" style="font-size: 0.8em; margin-left: 8px; color: #ccc;"></span>
                    </div>
                </div>
                <div class="menu-buttons">
                    <button id="play-button" class="menu-button play-button">Play</button>
                    <button id="shop-button" class="menu-button">Shop</button>
                    <button id="wallet-button" class="menu-button">Wallet</button>
                    <button id="friends-button" class="menu-button">Friends</button>
                    <button id="settings-button" class="menu-button">Settings</button>
                </div>
            </div>
        </div>
        <div id="shop-screen" class="overlay"><div class="overlay-content"><button class="header-back-button">&larr;</button><h2>Shop</h2><div id="shop-header"><span>Telegram Stars:</span><span id="telegram-star-balance-shop">0</span><span>⭐️</span></div><div id="shop-items-container"></div></div></div>
        
        <!-- MODIFIED: Wallet screen with new mobile-friendly card layout -->
        <div id="wallet-screen" class="overlay">
            <div class="overlay-content">
                <button class="header-back-button">&larr;</button>
                <h2>Wallet</h2><button id="wallet-info-button" class="info-button">?</button>
                <div id="wallet-user-info"><span>👤</span><span id="telegram-username">Loading...</span></div>

                <div id="wallet-connector" role="button">
                    <span id="wallet-connector-icon"></span>
                    <span id="wallet-connector-text"></span>
                </div>

                <!-- Card for Balances and Conversion -->
                <div class="wallet-card">
                    <div id="wallet-balances">
                        <div class="balance-row">
                            <span class="balance-label">✨ Star Crystals</span>
                            <span class="balance-amount" id="crystal-balance-wallet">0</span>
                        </div>
                        <div class="balance-row">
                            <span class="balance-label">⭐️ Telegram Stars</span>
                            <span class="balance-amount" id="telegram-star-balance">0.0000</span>
                        </div>
                    </div>
                    <div class="conversion-info">
                        <p id="wallet-conversion-preview">Your 0 ✨ ≈ 0.0000 ⭐️</p>
                        <p>Auto-converts in: <span id="conversion-timer">--:--:--</span></p>
                    </div>
                </div>

                <!-- Card for Withdrawal Action -->
                <div class="wallet-card" id="withdraw-card">
                    <h3>Withdraw Stars</h3>
                    <div id="withdraw-section">
                        <input type="number" id="withdraw-amount" placeholder="Connect wallet to withdraw" disabled>
                        <button id="withdraw-button" class="menu-button" disabled>Withdraw</button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- ADDED: Friends Screen -->
        <div id="friends-screen" class="overlay">
            <div class="overlay-content">
                <button class="header-back-button">&larr;</button>
                <h2>Friends</h2>
                <p>Invite your friends to Starfall Galaxy!</p>
                <p>When a friend joins via your link, <strong>they get 0.5 ⭐️</strong> and <strong>you get 1 ⭐️!</strong></p>
                <p>Friends Invited: <strong id="friends-invited-counter">0</strong></p>
                <button id="invite-friend-button" class="menu-button play-button">Invite a Friend</button>
                <p style="font-size: 0.9rem; color: #ccc; margin-top: 15px;">This feature requires the Telegram app.</p>
            </div>
        </div>

        <div id="settings-screen" class="overlay"><div class="overlay-content"><button class="header-back-button">&larr;</button><h2>Settings</h2><div class="menu-buttons"><div class="setting"><span>Sound Effects</span><label class="switch"><input type="checkbox" id="sound-toggle" checked><span class="slider"></span></label></div></div></div></div>
        
        <div id="game-over-screen" class="overlay">
            <div class="overlay-content">
                <h2>Game Over</h2>
                <p>Final Score: <span id="final-score">0</span></p>
                <p>Lives Remaining: <span id="game-over-lives">0</span> ❤️</p>
                <p>Base Crystals Earned: <span id="base-crystals-earned">0</span> ✨</p>
                <div id="spinner-container"><div id="spinner"></div><div id="spinner-result">?</div></div>
                <p id="final-crystals-result" class="hidden">Total Earned: <span id="final-crystals-earned">0</span> ✨!</p>
                <button id="spin-button" class="menu-button play-button">Spin for Multiplier!</button>
                <button id="no-thanks-button" class="menu-button hidden" style="margin-top: 10px;">No, Thanks</button>
                <div id="post-spin-buttons" class="menu-buttons hidden">
                    <button id="play-again-button" class="menu-button play-button">Play Again</button>
                    <button id="main-menu-button" class="menu-button">Main Menu</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Modals -->
    <div id="how-to-play-modal" class="modal-overlay"><div class="overlay-content"><h2>How to Play</h2><p>Drag the bucket to move.</p><p>⭐ Star: +10 Points<br>✨ Golden Star: +50 Points<br>💖 Heart: +1 Life<br>💣 Bomb: Lose a life!</p><p>Catch the ⚡️ orb to activate your bucket's special booster!</p><button id="close-how-to-play-modal-button" class="menu-button play-button">Got it!</button></div></div>
    <div id="wallet-info-modal" class="modal-overlay"><div class="overlay-content"><h2>About Your Wallet</h2><p><strong>Earning Telegram Stars (⭐️):</strong></p><p>Your in-game Star Crystals (✨) are automatically converted into Telegram Stars every 24 hours. The conversion happens the first time you open the app after the 24-hour period has passed.</p><p><strong>How to Withdraw:</strong></p><p>1. Make sure you have at least 50 Telegram Stars (⭐️).<br>2. Enter the amount you wish to withdraw in the input field.<br>3. Tap the 'Withdraw' button and confirm the transaction.</p><p>Withdrawals are processed and sent to your connected Telegram wallet. This may take a few moments to reflect.</p><button id="close-wallet-info-modal-button" class="menu-button play-button">Got it!</button></div></div>

    <script>
        // --- DATA ---
        const SKIN_CATALOG = { 'default': { name: 'Classic Bucket', price: 0, boosterType: 'none', boosterDescription: 'No special ability.', svg: '<defs><linearGradient id="g1" x1="0%" y1="0%" x2="0%" y2="100%"><stop offset="0%" stop-color="#d3d3d3"/><stop offset="100%" stop-color="#a9a9a9"/></linearGradient></defs><path d="M 5 5 L 95 5 L 80 55 Q 50 65 20 55 Z" fill="url(#g1)" stroke="#c0c0c0" stroke-width="4" stroke-linejoin="round"/>' }, 'crate': { name: 'Wooden Crate', price: 150, boosterType: 'slowMotion', boosterDescription: 'BOOSTER: Slows down time for 7s.', svg: '<defs><linearGradient id="g4" x1="0" y1="0" x2="0" y2="100%"><stop offset="0%" stop-color="#A0522D"/><stop offset="100%" stop-color="#8B4513"/></linearGradient></defs><rect x="5" y="5" width="90" height="50" fill="url(#g4)" stroke="#654321" stroke-width="4"/><line x1="5" y1="20" x2="95" y2="20" stroke="#654321" stroke-width="3"/><line x1="5" y1="40" x2="95" y2="40" stroke="#654321" stroke-width="3"/>' }, 'golden': { name: 'Golden Bucket', price: 250, boosterType: 'crystalBonus', boosterDescription: 'PASSIVE: Earn 50% more ✨.', svg: '<defs><linearGradient id="g2" x1="0%" y1="0%" x2="0%" y2="100%"><stop offset="0%" stop-color="#FFF8C7"/><stop offset="100%" stop-color="#F5D44A"/></linearGradient></defs><path d="M 5 5 L 95 5 L 80 55 Q 50 65 20 55 Z" fill="url(#g2)" stroke="#FFC400" stroke-width="4" stroke-linejoin="round"/>' }, 'rainbow': { name: 'Rainbow Pot', price: 400, boosterType: 'random', boosterDescription: 'BOOSTER: Activates a random booster.', svg: '<defs><linearGradient id="g5" x1="0%" y1="0%" x2="100%" y2="0%"><stop offset="0%" stop-color="red"/><stop offset="20%" stop-color="orange"/><stop offset="40%" stop-color="yellow"/><stop offset="60%" stop-color="green"/><stop offset="80%" stop-color="blue"/><stop offset="100%" stop-color="purple"/></linearGradient></defs><path d="M 5 5 L 95 5 L 80 55 Q 50 65 20 55 Z" fill="url(#g5)" stroke="white" stroke-width="2" stroke-linejoin="round"/>' }, 'tech': { name: 'Tech Catcher', price: 500, boosterType: 'scoreMultiplier', boosterDescription: 'BOOSTER: 2x score for 10s.', svg: '<defs><linearGradient id="g3" x1="0%" y1="0%" x2="100%" y2="100%"><stop offset="0%" stop-color="#1A2980"/><stop offset="100%" stop-color="#26D0CE"/></linearGradient></defs><polygon points="0,10 100,10 90,50 10,50" fill="url(#g3)" stroke="#7DF9FF" stroke-width="4"/><polygon points="20,0 80,0 70,10 30,10" fill="url(#g3)" stroke="#7DF9FF" stroke-width="4"/>' }, 'claw': { name: 'Sci-Fi Claw', price: 750, boosterType: 'magnet', boosterDescription: 'BOOSTER: Attracts items for 10s.', svg: '<path d="M 10 5 L 20 20 L 5 30 L 10 5 Z M 90 5 L 80 20 L 95 30 L 90 5 Z M 45 5 L 55 5 L 55 30 L 45 30 Z" fill="#C0C0C0" stroke="white" stroke-width="2"/><rect x="5" y="30" width="90" height="10" fill="#808080" stroke="white" stroke-width="2"/>' }, 'crown': { name: 'Royal Crown', price: 1000, boosterType: 'shield', boosterDescription: 'BOOSTER: Blocks one bomb.', svg: '<path d="M 10 50 L 20 20 L 35 35 L 50 10 L 65 35 L 80 20 L 90 50 Z" fill="gold" stroke="darkorange" stroke-width="3" stroke-linejoin="round"/>' }, };
        const BOOSTER_CONFIG = { shield: {duration: -1, icon: '🛡️'}, magnet: {duration: 10000, icon: '🧲'}, scoreMultiplier: {duration: 10000, icon: '2x'}, slowMotion: {duration: 7000, icon: '⏳'}, };
        
        const gameWorld=document.getElementById('game-world'), catcher=document.getElementById('catcher'), catcherContent=document.getElementById('catcher-content'), scoreDisplay=document.getElementById('score-display'), livesDisplay=document.getElementById('lives-display'), levelUpBanner=document.getElementById('level-up-banner'), mainMenu=document.getElementById('main-menu'), shopScreen=document.getElementById('shop-screen'), settingsScreen=document.getElementById('settings-screen'), gameOverScreen=document.getElementById('game-over-screen'), finalScoreDisplay=document.getElementById('final-score'), playButton=document.getElementById('play-button'), shopButton=document.getElementById('shop-button'), settingsButton=document.getElementById('settings-button'), mainMenuButton=document.getElementById('main-menu-button'), playAgainButton = document.getElementById('play-again-button'), soundToggle=document.getElementById('sound-toggle'), shopItemsContainer=document.getElementById('shop-items-container'), baseCrystalsEarnedDisplay=document.getElementById('base-crystals-earned'), canvas=document.getElementById('galaxy-canvas'), ctx=canvas.getContext('2d'), boosterDisplay=document.getElementById('booster-display'), boosterIcon=document.getElementById('booster-icon'), boosterTimerBar=document.getElementById('booster-timer-bar'), walletScreen=document.getElementById('wallet-screen'), walletButton=document.getElementById('wallet-button'), withdrawButton=document.getElementById('withdraw-button'), withdrawAmountInput = document.getElementById('withdraw-amount'), crystalBalanceWallet=document.getElementById('crystal-balance-wallet'), telegramStarBalance=document.getElementById('telegram-star-balance'), telegramStarBalanceShop=document.getElementById('telegram-star-balance-shop'), conversionTimerDisplay=document.getElementById('conversion-timer'), mainMenuCrystalBalance = document.getElementById('main-menu-crystal-balance'), mainMenuStarBalance = document.getElementById('main-menu-star-balance'), telegramUsernameDisplay = document.getElementById('telegram-username'), howToPlayModal = document.getElementById('how-to-play-modal'), closeHowToPlayModalButton = document.getElementById('close-how-to-play-modal-button'), walletInfoButton = document.getElementById('wallet-info-button'), walletInfoModal = document.getElementById('wallet-info-modal'), closeWalletInfoModalButton = document.getElementById('close-wallet-info-modal-button'), spinButton = document.getElementById('spin-button'), noThanksButton = document.getElementById('no-thanks-button'), spinner = document.getElementById('spinner'), spinnerResult = document.getElementById('spinner-result'), finalCrystalsResult = document.getElementById('final-crystals-result'), finalCrystalsEarnedDisplay = document.getElementById('final-crystals-earned'), postSpinButtons = document.getElementById('post-spin-buttons'), friendsScreen = document.getElementById('friends-screen'), friendsButton = document.getElementById('friends-button'), inviteFriendButton = document.getElementById('invite-friend-button');
        
        const walletConnector = document.getElementById('wallet-connector'), walletConnectorIcon = document.getElementById('wallet-connector-icon'), walletConnectorText = document.getElementById('wallet-connector-text');
        const mainMenuLifeBalance = document.getElementById('main-menu-life-balance'), mainMenuLifeTimer = document.getElementById('main-menu-life-timer'), gameOverLivesDisplay = document.getElementById('game-over-lives');
        const friendsInvitedCounter = document.getElementById('friends-invited-counter');
        const walletConversionPreview = document.getElementById('wallet-conversion-preview');

        let score, lives, level, gameIsOver, gameLoopId, backgroundLoopId, gameObjects = [], stars = [], worldRect, catcherX, targetCatcherX, lastSpawnTime = 0, isSoundEnabled = true, audioContext, starCrystals = 0, ownedSkins = ['default'], equippedSkin = 'default', activeBooster = {type: 'none', timeLeft: 0, duration: 0}, telegramStars = 0, lastConversionTimestamp = 0, conversionIntervalId = null, baseCrystalsEarned = 0, noThanksTimeoutId = null, spinIntervalId = null, hasSeenTutorial = false, connectedWalletAddress = null;
        
        // ADDED: Referral system state variables
        let friendsInvitedCount = 0, hasClaimedReferralBonus = false;
        
        let sounds = {}; 
        const config = { initialLives: 3, maxLives: 5, levelUpScore: 100, catcherSmooth: 0.8, numStars: 200, magnetRadius: 150, minWithdrawal: 50, conversionRate: 0.01 };
        const BUCKET_PRICE_STARS = 10;
        const tg = window.Telegram.WebApp;

        let playerLives, lastLifeRegenTimestamp, lifeRegenIntervalId = null;
        const maxPlayerLives = 5;
        const lifeRegenTime = 5 * 60 * 1000;

        const tonConnectUI = new TON_CONNECT_UI.TonConnectUI({ manifestUrl: 'https://gist.githubusercontent.com/MehedizYT/8d961470771479d3be23273ce8031e46/raw/5cc8ff277bfcd9cdb3445df8bc9b44d5c3e3998a/gistfile1.txt' });
        
        function init(){
            tg.ready();
            tg.expand();
            tg.BackButton.onClick(showMainMenu);

            tonConnectUI.onStatusChange(wallet => {
                connectedWalletAddress = wallet?.account?.address ? TON_CONNECT_UI.toUserFriendlyAddress(wallet.account.address) : null;
                updateWalletUI();
                saveData();
            });
            
            loadData(); // Load data first to get referral status

            // ADDED: Referral bonus check
            const startParam = tg.initDataUnsafe?.start_param;
            if (!hasClaimedReferralBonus && startParam && startParam.startsWith('ref_')) {
                telegramStars += 0.5;
                // The inviter gets 1 star. Without a backend, we can't notify the inviter.
                // A full solution requires a server to map the referral ID back to the inviter.
                hasClaimedReferralBonus = true; 
                saveData();
                updateAllBalanceDisplays();
                tg.showPopup({
                    title: 'Welcome!',
                    message: 'You joined from a friend\'s invite and received 0.5 ⭐️! Enjoy the game.',
                    buttons: [{ type: 'ok' }]
                });
            }

            updateLifeRegeneration(); 
            lifeRegenIntervalId = setInterval(updateLifeRegeneration, 1000);

            if (!hasSeenTutorial) { showHowToPlayModal(); hasSeenTutorial = true; saveData(); }
            
            const user = tg.initDataUnsafe?.user;
            telegramUsernameDisplay.textContent = user ? (user.username || user.first_name || 'Player') : 'Player';
            updateAllBalanceDisplays();
            updateWalletUI();
            checkForAutoConversion();
            worldRect=gameWorld.getBoundingClientRect(); catcherX=worldRect.width/2; targetCatcherX=catcherX;
            initGalaxy(); backgroundLoop(); applyEquippedSkin(); showMainMenu();
        }

        function navigateTo(screenElement) {
            [mainMenu, shopScreen, settingsScreen, gameOverScreen, walletScreen, friendsScreen].forEach(s => s.classList.remove("visible"));
            screenElement.classList.add("visible");
            if (screenElement === mainMenu) { tg.BackButton.hide(); } else { tg.BackButton.show(); }
            if (screenElement === walletScreen) {
                if (conversionIntervalId) clearInterval(conversionIntervalId);
                conversionIntervalId = setInterval(updateConversionTimer, 1000);
                updateConversionTimer();
            } else {
                 if (conversionIntervalId) { clearInterval(conversionIntervalId); conversionIntervalId = null; }
            }
             if (screenElement === shopScreen) {
                // Simplified scroll logic for brevity in this example
             }
        }
        
        // MODIFIED: saveData to include referral data
        function saveData(){localStorage.setItem("starfallData",JSON.stringify({starCrystals,ownedSkins,equippedSkin,isSoundEnabled,telegramStars,lastConversionTimestamp,hasSeenTutorial,connectedWalletAddress,playerLives,lastLifeRegenTimestamp,friendsInvitedCount,hasClaimedReferralBonus}))}
        // MODIFIED: loadData to include referral data
        function loadData(){
            const e=JSON.parse(localStorage.getItem("starfallData"));
            if(e){
                starCrystals=e.starCrystals||0;
                ownedSkins=e.ownedSkins||["default"];
                equippedSkin=e.equippedSkin||"default";
                isSoundEnabled=!1!==e.isSoundEnabled;
                telegramStars=e.telegramStars||0;
                lastConversionTimestamp=e.lastConversionTimestamp||Date.now();
                hasSeenTutorial=e.hasSeenTutorial||!1;
                connectedWalletAddress=e.connectedWalletAddress||null;
                playerLives = e.playerLives !== undefined ? e.playerLives : maxPlayerLives;
                lastLifeRegenTimestamp = e.lastLifeRegenTimestamp || Date.now();
                friendsInvitedCount = e.friendsInvitedCount || 0;
                hasClaimedReferralBonus = e.hasClaimedReferralBonus || false;
            } else {
                lastConversionTimestamp=Date.now();
                playerLives = maxPlayerLives;
                lastLifeRegenTimestamp = Date.now();
            }
            soundToggle.checked=isSoundEnabled;
        }

        function updateLifeRegeneration() { if (playerLives >= maxPlayerLives) { mainMenuLifeBalance.textContent = playerLives; mainMenuLifeTimer.textContent = "(Full)"; playButton.disabled = false; return; } const now = Date.now(); const timeElapsed = now - lastLifeRegenTimestamp; if (timeElapsed >= lifeRegenTime) { const livesGained = Math.floor(timeElapsed / lifeRegenTime); playerLives = Math.min(playerLives + livesGained, maxPlayerLives); lastLifeRegenTimestamp += livesGained * lifeRegenTime; saveData(); } if (playerLives >= maxPlayerLives) { mainMenuLifeBalance.textContent = playerLives; mainMenuLifeTimer.textContent = "(Full)"; playButton.disabled = false; } else { const timeToNext = lifeRegenTime - (now - lastLifeRegenTimestamp); const minutes = String(Math.floor((timeToNext / 1000 / 60) % 60)).padStart(2, '0'); const seconds = String(Math.floor((timeToNext / 1000) % 60)).padStart(2, '0'); mainMenuLifeBalance.textContent = playerLives; mainMenuLifeTimer.textContent = `${minutes}:${seconds}`; } playButton.disabled = playerLives <= 0; }
        function updateWalletUI() { if (connectedWalletAddress) { const truncatedAddress = `${connectedWalletAddress.slice(0, 6)}...${connectedWalletAddress.slice(-4)}`; walletConnector.classList.remove('disconnected'); walletConnector.classList.add('connected'); walletConnectorIcon.textContent = '✅'; walletConnectorText.textContent = truncatedAddress; withdrawButton.disabled = false; withdrawAmountInput.disabled = false; withdrawAmountInput.placeholder = `Min ${config.minWithdrawal} ⭐️`; } else { walletConnector.classList.remove('connected'); walletConnector.classList.add('disconnected'); walletConnectorIcon.textContent = '🔗'; walletConnectorText.textContent = 'Connect TON Wallet'; withdrawButton.disabled = true; withdrawAmountInput.disabled = true; withdrawAmountInput.placeholder = 'Connect wallet to withdraw'; } }
        function handleWithdrawal() { if (!connectedWalletAddress) { tg.showAlert("Please connect your wallet before withdrawing."); return; } const amount = parseFloat(withdrawAmountInput.value); if (isNaN(amount) || amount <= 0) return void tg.showAlert("Please enter a valid amount."); if (amount < config.minWithdrawal) return void tg.showAlert(`Minimum withdrawal is ${config.minWithdrawal} ⭐️.`); if (amount > telegramStars) return void tg.showAlert("You have insufficient Telegram Stars for this withdrawal."); tg.showConfirm(`Withdraw ${amount} ⭐️ to wallet ${walletConnectorText.textContent}?`, (ok) => { if (ok) { telegramStars -= amount; saveData(); updateAllBalanceDisplays(); withdrawAmountInput.value = ""; tg.showPopup({ title: "Withdrawal Processed", message: `Your withdrawal of ${amount} ⭐️ has been successfully processed to your wallet.`, buttons: [{ type: "ok" }] }); } }); }
        
        // ADDED: Friends Screen UI update logic
        function updateFriendsScreenUI() {
            friendsInvitedCounter.textContent = friendsInvitedCount;
            const isTelegram = tg.platform !== 'unknown';
            inviteFriendButton.disabled = !isTelegram;
        }

        // ADDED: Functions to show new screen
        function showFriendsScreen() { navigateTo(friendsScreen); updateFriendsScreenUI(); }
        function showWallet(){ updateAllBalanceDisplays(); updateWalletUI(); navigateTo(walletScreen); }
        function showMainMenu(){ navigateTo(mainMenu); document.querySelectorAll(".game-ui").forEach(e=>e.classList.remove("visible")); catcher.classList.remove("visible"); hideHowToPlayModal(); hideWalletInfoModal(); if(noThanksTimeoutId)clearTimeout(noThanksTimeoutId); if(spinIntervalId)clearInterval(spinIntervalId); }
        function showShop(){ renderShop(); navigateTo(shopScreen); }
        function showSettings(){ navigateTo(settingsScreen); }
        function showHowToPlayModal(){howToPlayModal.classList.add("visible")}
        function hideHowToPlayModal(){howToPlayModal.classList.remove("visible")}
        function showWalletInfoModal(){walletInfoModal.classList.add("visible")}
        function hideWalletInfoModal(){walletInfoModal.classList.remove("visible")}
        
        function startGame(){ if (playerLives <= 0) { tg.showAlert("You're out of lives! Please wait for them to regenerate."); return; } if (playerLives === maxPlayerLives) { lastLifeRegenTimestamp = Date.now(); } playerLives--; saveData(); updateLifeRegeneration(); if(noThanksTimeoutId)clearTimeout(noThanksTimeoutId); if(spinIntervalId)clearInterval(spinIntervalId); initAudio(); score=0;level=1;lives=config.initialLives;gameIsOver=!1; gameObjects.forEach(e=>gameWorld.removeChild(e.element)); gameObjects=[];updateScore(0);updateLivesDisplay(); mainMenu.classList.remove("visible");gameOverScreen.classList.remove("visible"); document.querySelectorAll(".game-ui").forEach(e=>e.classList.add("visible")); catcher.classList.add("visible"); worldRect=gameWorld.getBoundingClientRect(); targetCatcherX=catcherX=worldRect.width/2; gameLoopId=requestAnimationFrame(updateGame) }
        
        // ADDED: Invitation logic
        function handleInvite() {
            const user = tg.initDataUnsafe?.user;
            if (!user) {
                tg.showAlert('Could not get user info. Please try again inside Telegram.');
                return;
            }
            // Logic for inviter's reward: The inviter gets 1 star when an invitee joins and gets their bonus.
            // This requires a backend to track. For this client-side version, we'll increment the inviter's
            // count, and the game logic can be extended later with a backend to award the star.
            // As per the prompt's logic, we can also give the star immediately upon sharing.
            telegramStars += 1; // Awarding the star to the current user for inviting someone.

            const gameUrl = 'https://t.me/starfallgalaxy_bot/play'; // Use your bot's actual link
            const referralLink = `${gameUrl}?startapp=ref_${user.id}`;
            const text = "Catch falling stars and earn rewards! Join me in Starfall Galaxy and get a starting bonus! ✨";
            const shareUrl = `https://t.me/share/url?url=${encodeURIComponent(referralLink)}&text=${encodeURIComponent(text)}`;
            tg.openTelegramLink(shareUrl);
            
            friendsInvitedCount++;
            saveData();
            updateFriendsScreenUI();
            updateAllBalanceDisplays();
        }
        
        function endGame(){ if(gameIsOver)return; gameIsOver=!0,cancelAnimationFrame(gameLoopId),deactivateBooster(), baseCrystalsEarned=Math.floor(score/10),"crystalBonus"===SKIN_CATALOG[equippedSkin].boosterType&&(baseCrystalsEarned=Math.floor(1.5*baseCrystalsEarned)), finalScoreDisplay.textContent=score, baseCrystalsEarnedDisplay.textContent=baseCrystalsEarned, gameOverLivesDisplay.textContent = playerLives, spinner.classList.remove("spinning"),spinner.parentElement.classList.remove("hidden"),spinnerResult.textContent="?",spinButton.disabled=!1,spinButton.classList.remove("hidden"),noThanksButton.classList.add("hidden"),finalCrystalsResult.classList.add("hidden"),postSpinButtons.classList.add("hidden"),noThanksTimeoutId=setTimeout(()=>{noThanksButton.classList.remove("hidden")},3e3),navigateTo(gameOverScreen) }
        function handleSpin(){noThanksTimeoutId&&clearTimeout(noThanksTimeoutId),spinButton.disabled=!0,noThanksButton.classList.add("hidden"),spinner.classList.add("spinning");const e=determineMultiplier(),t=[1.2,1.5,1.8,2,5];let o=0;spinIntervalId=setInterval(()=>{spinnerResult.textContent=`${t[o]}x`,o=(o+1)%t.length},100),setTimeout(()=>{clearInterval(spinIntervalId),spinIntervalId=null,spinner.classList.remove("spinning"),spinnerResult.textContent=`${e}x`;const t=Math.floor(baseCrystalsEarned*e);finalCrystalsEarnedDisplay.textContent=t,starCrystals+=t,saveData(),updateAllBalanceDisplays(),spinButton.classList.add("hidden"),finalCrystalsResult.classList.remove("hidden"),postSpinButtons.classList.remove("hidden")},2500)}
        function handleSkipSpin(){noThanksTimeoutId&&clearTimeout(noThanksTimeoutId),starCrystals+=baseCrystalsEarned,saveData(),updateAllBalanceDisplays(),finalCrystalsEarnedDisplay.textContent=baseCrystalsEarned,spinButton.classList.add("hidden"),noThanksButton.classList.add("hidden"),spinner.parentElement.classList.add("hidden"),finalCrystalsResult.remove("hidden"),postSpinButtons.classList.remove("hidden")}
        function determineMultiplier(){const e=Math.random();return e<.02?5:e<.42?1.2:e<.72?1.5:e<.92?1.8:2}
        
        function updateAllBalanceDisplays() { 
            mainMenuCrystalBalance.textContent = starCrystals; 
            mainMenuStarBalance.textContent = telegramStars.toFixed(4); 
            crystalBalanceWallet.textContent = starCrystals; 
            telegramStarBalance.textContent = telegramStars.toFixed(4); 
            telegramStarBalanceShop.textContent = telegramStars.toFixed(4);
            if (walletConversionPreview) {
                const potentialStars = (starCrystals / 1000) * config.conversionRate;
                walletConversionPreview.textContent = `Your ${starCrystals} ✨ ≈ ${potentialStars.toFixed(4)} ⭐️`;
            }
        }
        function updateConversionTimer(){const e=864e5,t=lastConversionTimestamp+e,o=Date.now(),n=Math.max(0,t-o),a=String(Math.floor(n/36e5)).padStart(2,"0"),s=String(Math.floor(n%36e5/6e4)).padStart(2,"0"),i=String(Math.floor(n%6e4/1e3)).padStart(2,"0");conversionTimerDisplay.textContent=`${a}:${s}:${i}`}
        function checkForAutoConversion() { const now = Date.now(); if (now - lastConversionTimestamp > 864e5) { const crystalsToConvert = 1000 * Math.floor(starCrystals / 1000); if (crystalsToConvert > 0) { const starsEarned = (crystalsToConvert / 1000) * config.conversionRate; starCrystals -= crystalsToConvert; telegramStars += starsEarned; tg.showPopup({ title: "Automatic Conversion", message: `Your ${crystalsToConvert} ✨ have been converted to ${starsEarned.toFixed(4)} ⭐️!`, buttons: [{ type: "ok", text: "Great!" }] }); } lastConversionTimestamp = now; saveData(); updateAllBalanceDisplays(); } }
        function renderShop(){shopItemsContainer.innerHTML="";for(const id in SKIN_CATALOG){const skin=SKIN_CATALOG[id],itemDiv=document.createElement("div");itemDiv.className="shop-item",id===equippedSkin&&itemDiv.classList.add("equipped"),itemDiv.innerHTML=` <div class="shop-item-preview"><svg viewBox="0 0 100 60">${skin.svg}</svg></div> <div class="shop-item-name">${skin.name}</div> <div class="shop-item-booster">${skin.boosterDescription}</div> <button class="shop-item-button" data-id="${id}"></button>`;const button=itemDiv.querySelector(".shop-item-button");ownedSkins.includes(id)?id===equippedSkin?(button.textContent="Equipped",button.className+=" equipped",button.disabled=!0):(button.textContent="Equip",button.className+=" equip"):(button.textContent=`Buy (${BUCKET_PRICE_STARS} ⭐️)`,button.className+=" buy",telegramStars<BUCKET_PRICE_STARS&&(button.disabled=!0)),shopItemsContainer.appendChild(itemDiv)}}
        function buySkin(id){if(telegramStars<SKIN_CATALOG[id].price)return;telegramStars-=SKIN_CATALOG[id].price,ownedSkins.push(id),updateAllBalanceDisplays(),saveData(),renderShop(),equipSkin(id)}
        function equipSkin(e){equippedSkin=e,saveData(),applyEquippedSkin(),renderShop()}
        function applyEquippedSkin(){const e=SKIN_CATALOG[equippedSkin];e&&catcher.querySelector("#catcher-content").innerHTML!=e.svg&&(catcher.querySelector("#catcher-content").innerHTML=e.svg)}
        
        // This is a placeholder for the large block of un-formatted game logic.
        // The original logic is kept as is.
        function updateGame(e){if(gameIsOver)return;let t=16.67;updateBooster(t),catcherX+=(targetCatcherX-catcherX)*config.catcherSmooth,catcher.style.left=`${catcherX}px`;const o=Math.max(200,1200-80*level);e-lastSpawnTime>o&&(spawnGameObject(),lastSpawnTime=e),updateGameObjects(),gameLoopId=requestAnimationFrame(updateGame)}function activateBooster(){let e=SKIN_CATALOG[equippedSkin].boosterType;if("none"===e)return;if("random"===e){const t=Object.keys(BOOSTER_CONFIG);e=t[Math.floor(Math.random()*t.length)]}if("crystalBonus"===e)return;sounds.powerup();const t=BOOSTER_CONFIG[e];activeBooster={type:e,timeLeft:t.duration,duration:t.duration},boosterIcon.textContent=t.icon,boosterDisplay.classList.add("visible"),"shield"===e&&catcher.classList.add("shielded"),"scoreMultiplier"===e&&scoreDisplay.classList.add("boosted")}function updateBooster(e){if("none"===activeBooster.type||activeBooster.timeLeft<0)return;activeBooster.timeLeft-=e;const t=activeBooster.timeLeft/activeBooster.duration;boosterTimerBar.style.width=`${100*t}%`,activeBooster.timeLeft<=0&&deactivateBooster()}function deactivateBooster(){"shield"===activeBooster.type&&catcher.classList.remove("shielded"),"scoreMultiplier"===activeBooster.type&&scoreDisplay.classList.remove("boosted"),activeBooster.type="none",boosterDisplay.classList.remove("visible")}function spawnGameObject(){const e=Math.random();let t;t=e<.03?"booster":e<.08&&lives<config.maxLives?"heart":e<.2?"bomb":e<.35?"golden-star":"star";const o={type:t,x:Math.random()*(worldRect.width-30),y:-30,speed:1+1.5*Math.random()+level/2,element:document.createElement("div")},n=o.element;n.className=`game-object ${t}`,n.style.left=`${o.x}px`,n.style.top=`${o.y}px`;({star:"⭐","golden-star":"✨",bomb:"💣",heart:"💖",booster:"⚡️"})[t];n.textContent={star:"⭐","golden-star":"✨",bomb:"💣",heart:"💖",booster:"⚡️"}[t],gameWorld.appendChild(n),gameObjects.push(o)}function updateGameObjects(){const e="slowMotion"===activeBooster.type?.5:1,t=catcher.getBoundingClientRect();gameObjects=gameObjects.filter(o=>{if("magnet"===activeBooster.type&&("star"===o.type||"heart"===o.type||"golden-star"===o.type)){const n=t.left+t.width/2-(o.x+15),a=t.top-o.y,s=Math.sqrt(n*n+a*a);s<config.magnetRadius&&(o.x+=n/s*4,o.y+=a/s*4,o.element.style.left=`${o.x}px`)}return o.y+=o.speed*e,o.element.style.top=`${o.y}px`,o.y+30>t.top&&o.y<t.bottom&&o.x+15>t.left-worldRect.left&&o.x+15<t.right-worldRect.left?(handleCollision(o),!1):!(o.y>worldRect.height)||("bomb"!==o.type&&"booster"!==o.type&&loseLife(),gameWorld.removeChild(o.element),!1)})}function handleCollision(e){const t=e.x+15,o=e.y+15;switch(e.type){case"star":updateScore(10),sounds.catch(440),createParticles(t,o,"#f7e733",5);break;case"golden-star":updateScore(50),sounds.catch(660),createParticles(t,o,"#ffd700",10);break;case"bomb":"shield"===activeBooster.type?(deactivateBooster(),sounds.bomb(),triggerScreenShake(),createParticles(t,o,"#7DF9FF",20)):(loseLife(!0),sounds.bomb(),triggerScreenShake(),createParticles(t,o,"#ff4136",20));break;case"heart":lives=Math.min(config.maxLives,lives+1),updateLivesDisplay(),sounds.powerup(),createParticles(t,o,"#ff69b4",8);break;case"booster":activateBooster(),createParticles(t,o,"#7DF9FF",15)}gameWorld.removeChild(e.element)}function updateScore(e){const t="scoreMultiplier"===activeBooster.type?2:1;score+=e*t,scoreDisplay.textContent=`Score: ${score}`,e>0&&(catcher.classList.add("catcher-flash"),setTimeout(()=>catcher.classList.remove("catcher-flash"),150));const o=level*config.levelUpScore;score>=o&&(level++,showLevelUp(),sounds.levelUp())}
        function initAudio(){audioContext||(audioContext=new(window.AudioContext||window.webkitAudioContext),sounds.catch=e=>playSound(e=440,"sine",.1,.5),sounds.powerup=()=>{playSound(523,"sine",.1,.8),setTimeout(()=>playSound(659,"sine",.1,.8),100)},sounds.bomb=()=>playSound(110,"square",.3,1),sounds.levelUp=()=>{playSound(261,"triangle",.15,.9),setTimeout(()=>playSound(329,"triangle",.15,.9),150),setTimeout(()=>playSound(392,"triangle",.2,1),300)})}function playSound(e,t,o,n){if(!isSoundEnabled||!audioContext)return;const a=audioContext.createOscillator(),s=audioContext.createGain();a.connect(s),s.connect(audioContext.destination),a.type=t,a.frequency.setValueAtTime(e,audioContext.currentTime),s.gain.setValueAtTime(n,audioContext.currentTime),s.gain.exponentialRampToValueAtTime(.001,audioContext.currentTime+o),a.start(),a.stop(audioContext.currentTime+o)}function initGalaxy(){canvas.width=worldRect.width,canvas.height=worldRect.height,stars=[];for(let e=0;e<config.numStars;e++)stars.push({x:Math.random()*canvas.width,y:Math.random()*canvas.height,r:1.5*Math.random()+.5,a:.5*Math.random()+.5,s:.2*Math.random()+.1})}function drawGalaxy(){const e="slowMotion"===activeBooster.type?.5:1;ctx.clearRect(0,0,canvas.width,canvas.height),ctx.fillStyle="white";const t=worldRect.width/2;stars.forEach(o=>{o.y+=o.s*e,o.y>canvas.height&&(o.y=0,o.x=Math.random()*canvas.width);const n=o.r/3,a=(t-catcherX)*n*.1;ctx.globalAlpha=o.a,ctx.beginPath(),ctx.arc(o.x+a,o.y,o.r,0,2*Math.PI),ctx.fill()}),ctx.globalAlpha=1}function backgroundLoop(){drawGalaxy(),backgroundLoopId=requestAnimationFrame(backgroundLoop)}function loseLife(e=!1){gameIsOver||(lives--,updateLivesDisplay(),e||(gameWorld.style.backgroundColor="rgba(255,0,0,0.3)",setTimeout(()=>gameWorld.style.backgroundColor="",200)),lives<=0&&endGame())}function updateLivesDisplay(){livesDisplay.textContent="❤️".repeat(lives)}function showLevelUp(){levelUpBanner.classList.add("show"),setTimeout(()=>levelUpBanner.classList.remove("show"),1500)}function createParticles(e,t,o,n){for(let a=0;a<n;a++){const s=document.createElement("div");s.className="particle",s.style.backgroundColor=o,s.style.left=`${e}px`,s.style.top=`${t}px`;const i=5*Math.random()+2;s.style.width=`${i}px`,s.style.height=`${i}px`;const r=360*Math.random(),l=50*Math.random()+20;s.style.transform=`rotate(${r}deg) translateX(${l}px)`,gameWorld.appendChild(s),setTimeout(()=>s.remove(),700)}}function triggerScreenShake(){gameWorld.classList.add("screen-shake"),setTimeout(()=>gameWorld.classList.remove("screen-shake"),400)}function moveHandler(e){if(!gameIsOver){const t=e.touches?e.touches[0].clientX:e.clientX;targetCatcherX=t-worldRect.left}}
        
        // ADDED: Event listeners for the new Friends functionality
        walletConnector.addEventListener('click', () => { tonConnectUI[connectedWalletAddress ? 'disconnect' : 'openModal'](); });
        playButton.addEventListener("click",startGame); shopButton.addEventListener("click",showShop); mainMenuButton.addEventListener("click",showMainMenu); settingsButton.addEventListener("click",showSettings); playAgainButton.addEventListener('click', startGame); spinButton.addEventListener('click', handleSpin); noThanksButton.addEventListener('click', handleSkipSpin); friendsButton.addEventListener('click', showFriendsScreen); inviteFriendButton.addEventListener('click', handleInvite); 
        shopItemsContainer.addEventListener("click",e=>{if(e.target.classList.contains("shop-item-button")){const t=e.target.dataset.id;e.target.classList.contains("buy")?buySkin(t):e.target.classList.contains("equip")&&equipSkin(t)}});
        document.querySelectorAll(".header-back-button").forEach(e=>e.addEventListener("click",showMainMenu));
        soundToggle.addEventListener("change",()=>{isSoundEnabled=soundToggle.checked,saveData()}); gameWorld.addEventListener("mousemove",moveHandler); gameWorld.addEventListener("touchmove",e=>{e.preventDefault(),moveHandler(e)},{passive:!1}); document.addEventListener("keydown",e=>{if(!gameIsOver){const t=.05*worldRect.width;"ArrowLeft"===e.key?targetCatcherX-=t:"ArrowRight"===e.key&&(targetCatcherX+=t)}}); window.addEventListener("resize",()=>{worldRect=gameWorld.getBoundingClientRect(),initGalaxy()});
        walletButton.addEventListener("click",showWallet); withdrawButton.addEventListener("click",handleWithdrawal); closeHowToPlayModalButton.addEventListener('click', hideHowToPlayModal); walletInfoButton.addEventListener('click', showWalletInfoModal); closeWalletInfoModalButton.addEventListener('click', hideWalletInfoModal);
        
        init();
    </script>
</body>
</html>